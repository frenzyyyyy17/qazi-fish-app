[file content begin]
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Qazi Fish Traders - Complete Business Solution</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        input, textarea, select {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --success: #27ae60;
            --warning: #f39c12;
            --dark: #1a1a1a;
            --dark-card: #2d2d2d;
            --dark-border: #444;
            --text: #ffffff;
            --text-secondary: #cccccc;
        }

        body {
            background: var(--dark);
            color: var(--text);
            min-height: 100vh;
            padding: 10px;
            padding-bottom: 20px;
        }

        .app-container {
            max-width: 100%;
            margin: 0 auto;
            background: var(--dark-card);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.4rem;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .header p {
            font-weight: 500;
        }

        .current-shop {
            background: rgba(255,255,255,0.2);
            padding: 8px 12px;
            border-radius: 20px;
            margin-top: 10px;
            font-size: 0.8rem;
            display: inline-block;
            font-weight: 500;
        }

        .nav-tabs {
            display: flex;
            background: var(--primary);
            border-bottom: 1px solid var(--dark-border);
        }

        .nav-tab {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-size: 0.8rem;
            transition: all 0.3s;
            font-weight: 500;
        }

        .nav-tab.active {
            border-bottom-color: var(--accent);
            background: rgba(52, 152, 219, 0.1);
            color: var(--text);
        }

        .tab-content {
            display: none;
            padding: 15px;
            min-height: 60vh;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid var(--secondary);
        }

        .card h3 {
            color: var(--text);
            margin-bottom: 8px;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin: 12px 0;
        }

        .stat-item {
            text-align: center;
            padding: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            border: 1px solid var(--dark-border);
        }

        .stat-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--text);
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .btn {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-size: 0.9rem;
            margin-top: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background 0.3s;
            font-weight: 600;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn-success {
            background: var(--success);
        }

        .btn-warning {
            background: var(--warning);
        }

        .btn-danger {
            background: var(--accent);
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 0.8rem;
            width: auto;
            margin: 2px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            color: var(--text);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--dark-border);
            border-radius: 6px;
            font-size: 0.9rem;
            background: rgba(255,255,255,0.05);
            color: var(--text);
            font-weight: 500;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--secondary);
        }

        .invoice-items {
            margin: 12px 0;
        }

        .invoice-item {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid var(--secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-details {
            flex: 1;
        }

        .item-actions {
            display: flex;
            gap: 4px;
        }

        .customer-list, .invoices-list {
            max-height: 50vh;
            overflow-y: auto;
        }

        .amount-positive {
            color: var(--success);
            font-weight: bold;
        }

        .amount-negative {
            color: var(--accent);
            font-weight: bold;
        }

        .hidden {
            display: none !important;
        }

        .back-btn {
            background: none;
            border: none;
            color: var(--secondary);
            font-size: 1.1rem;
            cursor: pointer;
            margin-bottom: 12px;
            padding: 4px;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 30px 15px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 2.5rem;
            margin-bottom: 12px;
            color: var(--dark-border);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .action-buttons .btn {
            margin-top: 0;
            flex: 1;
        }

        .search-box {
            margin-bottom: 12px;
        }

        .search-box input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid var(--dark-border);
            border-radius: 20px;
            font-size: 0.8rem;
            background: rgba(255,255,255,0.05);
            color: var(--text);
            font-weight: 500;
        }

        .tab-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .section-title {
            color: var(--text);
            margin: 15px 0 8px 0;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--dark-border);
            font-size: 1rem;
            font-weight: bold;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .status-paid {
            background: rgba(39, 174, 96, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .status-pending {
            background: rgba(243, 156, 18, 0.2);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        .status-partial {
            background: rgba(52, 152, 219, 0.2);
            color: var(--secondary);
            border: 1px solid var(--secondary);
        }

        .total-amount {
            background: var(--primary);
            color: white;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            margin: 12px 0;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .shop-badge {
            background: var(--secondary);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.6rem;
            margin-left: 6px;
            font-weight: 600;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            font-weight: 600;
        }

        .logo-preview {
            width: 100px;
            height: 100px;
            border: 2px dashed var(--dark-border);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
            cursor: pointer;
            overflow: hidden;
        }

        .logo-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .stamp-preview {
            width: 120px;
            height: 80px;
            border: 2px dashed var(--dark-border);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
            cursor: pointer;
            overflow: hidden;
        }

        .stamp-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .file-input {
            display: none;
        }

        .payment-section {
            background: rgba(255,255,255,0.05);
            padding: 12px;
            border-radius: 6px;
            margin: 12px 0;
            border: 1px solid var(--dark-border);
        }

        .fish-item {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid var(--success);
        }

        .customer-details {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 3px solid var(--warning);
        }

        .payment-history {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            border-left: 3px solid var(--accent);
        }

        .payment-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid var(--dark-border);
            font-weight: 500;
        }

        .expense-item {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid var(--warning);
        }

        .invoice-preview {
            background: white;
            color: black;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
        }
        ::-webkit-scrollbar-track {
            background: var(--dark-border);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--secondary);
            border-radius: 2px;
        }

        /* Mobile-specific styles */
        @media (max-width: 768px) {
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .nav-tab {
                flex: 1 0 45%;
                font-size: 0.7rem;
                padding: 10px 5px;
                min-height: 50px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 5px;
            }
            
            .stat-item {
                padding: 6px;
            }
            
            .stat-value {
                font-size: 1rem;
            }
            
            .action-buttons {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .action-buttons .btn {
                flex: 1 0 45%;
                font-size: 0.8rem;
                padding: 10px 5px;
                min-height: 44px;
            }
            
            .btn-sm {
                padding: 8px 10px;
                font-size: 0.75rem;
                min-height: 36px;
            }
            
            .card {
                padding: 12px;
                margin-bottom: 10px;
            }
            
            .card h3 {
                font-size: 1rem;
            }
            
            .form-control {
                padding: 12px;
                font-size: 16px;
                min-height: 44px;
            }
            
            .tab-content {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.2rem;
            }
            
            .header p {
                font-size: 0.8rem;
            }
        }

        @media (max-width: 480px) {
            .nav-tab {
                flex: 1 0 100%;
                font-size: 0.8rem;
                padding: 12px 5px;
            }
            
            .action-buttons .btn {
                flex: 1 0 100%;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Payment status explanation */
        .payment-explanation {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 3px solid var(--secondary);
            font-size: 0.8rem;
        }

        .payment-explanation h4 {
            color: var(--text);
            margin-bottom: 5px;
            font-weight: bold;
        }

        .payment-explanation ul {
            padding-left: 15px;
        }

        .payment-explanation li {
            margin-bottom: 3px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>Qazi Fish Traders - Machli Market Turbat</h1>
            <p>Fresh Fish Wholesale & Retail | Professional Invoicing</p>
            <div class="current-shop" id="current-shop-display">
                <i class="fas fa-store"></i> No shop selected
            </div>
        </div>

        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="dashboard">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </div>
            <div class="nav-tab" data-tab="shops">
                <i class="fas fa-store"></i> Shops
            </div>
            <div class="nav-tab" data-tab="invoices">
                <i class="fas fa-receipt"></i> Invoices
            </div>
            <div class="nav-tab" data-tab="customers">
                <i class="fas fa-users"></i> Customers
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div class="tab-content active" id="dashboard-tab">
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="total-shops">0</div>
                    <div class="stat-label">Shops</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="total-customers">0</div>
                    <div class="stat-label">Customers</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="total-invoices">0</div>
                    <div class="stat-label">Invoices</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="total-revenue">Rs. 0</div>
                    <div class="stat-label">Revenue</div>
                </div>
            </div>

            <div class="card">
                <h3>Recent Invoices</h3>
                <div id="recent-invoices">
                    <div class="empty-state">
                        <i class="fas fa-receipt"></i>
                        <p>No invoices yet</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>Pending Payments</h3>
                <div id="pending-payments">
                    <div class="empty-state">
                        <i class="fas fa-clock"></i>
                        <p>No pending payments</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Shops Tab -->
        <div class="tab-content" id="shops-tab">
            <div id="shops-main">
                <button class="btn btn-success" onclick="showAddShopForm()">
                    <i class="fas fa-plus"></i> Add New Shop
                </button>
                <div id="shops-list" class="customer-list">
                    <!-- Shops will be loaded here -->
                </div>
            </div>

            <div id="add-shop-form" class="hidden">
                <button class="back-btn" onclick="hideAddShopForm()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <h3 style="margin-bottom: 15px;">Add New Shop</h3>
                <div class="form-group">
                    <label>Shop Name *</label>
                    <input type="text" id="shop-name" class="form-control" placeholder="Enter shop name">
                </div>
                <div class="form-group">
                    <label>Owner Name *</label>
                    <input type="text" id="shop-owner" class="form-control" placeholder="Enter owner name">
                </div>
                <div class="form-group">
                    <label>Phone Number *</label>
                    <input type="tel" id="shop-phone" class="form-control" placeholder="Enter phone number">
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <textarea id="shop-address" class="form-control" placeholder="Enter shop address" rows="2"></textarea>
                </div>

                <h4 class="section-title">Shop Branding</h4>
                
                <div class="form-group">
                    <label>Shop Logo</label>
                    <div class="logo-preview" onclick="document.getElementById('shop-logo-input').click()">
                        <i class="fas fa-camera"></i> Click to upload logo
                    </div>
                    <input type="file" id="shop-logo-input" class="file-input" accept="image/*" onchange="previewLogo(event)">
                </div>

                <div class="form-group">
                    <label>Shop Stamp</label>
                    <div class="stamp-preview" onclick="document.getElementById('shop-stamp-input').click()">
                        <i class="fas fa-stamp"></i> Click to upload stamp
                    </div>
                    <input type="file" id="shop-stamp-input" class="file-input" accept="image/*" onchange="previewStamp(event)">
                </div>

                <div class="action-buttons">
                    <button class="btn" onclick="hideAddShopForm()">Cancel</button>
                    <button class="btn btn-success" onclick="saveShop()">Save Shop</button>
                </div>
            </div>

            <!-- Edit Shop Form -->
            <div id="edit-shop-form" class="hidden">
                <button class="back-btn" onclick="hideEditShopForm()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <h3 style="margin-bottom: 15px;">Edit Shop</h3>
                <div class="form-group">
                    <label>Shop Name *</label>
                    <input type="text" id="edit-shop-name" class="form-control">
                </div>
                <div class="form-group">
                    <label>Owner Name *</label>
                    <input type="text" id="edit-shop-owner" class="form-control">
                </div>
                <div class="form-group">
                    <label>Phone Number *</label>
                    <input type="tel" id="edit-shop-phone" class="form-control">
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <textarea id="edit-shop-address" class="form-control" rows="2"></textarea>
                </div>

                <h4 class="section-title">Shop Branding</h4>
                
                <div class="form-group">
                    <label>Shop Logo</label>
                    <div class="logo-preview" id="edit-logo-preview" onclick="document.getElementById('edit-shop-logo-input').click()">
                        <i class="fas fa-camera"></i> Click to upload logo
                    </div>
                    <input type="file" id="edit-shop-logo-input" class="file-input" accept="image/*" onchange="previewEditLogo(event)">
                </div>

                <div class="form-group">
                    <label>Shop Stamp</label>
                    <div class="stamp-preview" id="edit-stamp-preview" onclick="document.getElementById('edit-shop-stamp-input').click()">
                        <i class="fas fa-stamp"></i> Click to upload stamp
                    </div>
                    <input type="file" id="edit-shop-stamp-input" class="file-input" accept="image/*" onchange="previewEditStamp(event)">
                </div>

                <div class="action-buttons">
                    <button class="btn" onclick="hideEditShopForm()">Cancel</button>
                    <button class="btn btn-success" onclick="updateShop()">Update Shop</button>
                    <button class="btn btn-danger" onclick="deleteCurrentShop()">
                        <i class="fas fa-trash"></i> Delete Shop
                    </button>
                </div>
            </div>
        </div>

        <!-- Invoices Tab -->
        <div class="tab-content" id="invoices-tab">
            <div id="invoices-main">
                <div class="tab-header">
                    <button class="btn btn-success btn-sm" onclick="showCreateInvoiceForm()">
                        <i class="fas fa-plus"></i> New Invoice
                    </button>
                    <div class="search-box">
                        <input type="text" id="invoice-search" placeholder="Search invoices..." onkeyup="searchInvoices()">
                    </div>
                </div>
                <div id="invoices-list" class="invoices-list">
                    <!-- Invoices will be loaded here -->
                </div>
            </div>

            <!-- Create Invoice Form -->
            <div id="create-invoice-form" class="hidden">
                <button class="back-btn" onclick="hideCreateInvoiceForm()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <h3 style="margin-bottom: 15px;">Create Professional Fish Invoice</h3>
                
                <div class="form-group">
                    <label>Select Shop *</label>
                    <select id="invoice-shop" class="form-control" onchange="loadShopCustomers()">
                        <option value="">Select Shop</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Select Customer *</label>
                    <select id="invoice-customer" class="form-control" onchange="loadCustomerDetails()">
                        <option value="">Select Customer</option>
                    </select>
                </div>

                <div id="customer-details-section" class="customer-details hidden">
                    <h4><i class="fas fa-user"></i> Customer Details</h4>
                    <div id="customer-details-display">
                        <!-- Customer details will appear here -->
                    </div>
                </div>

                <div class="form-group">
                    <label>Customer Balance</label>
                    <div id="customer-balance-display" style="padding: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; border: 1px solid var(--dark-border);">
                        Select a customer to view balance
                    </div>
                </div>

                <h4 class="section-title">Fish Items</h4>
                
                <div class="form-group">
                    <label>Fish Type *</label>
                    <select id="fish-type" class="form-control">
                        <option value="">Select Fish Type</option>
                        <option value="Rohu">Rohu</option>
                        <option value="Katla">Katla</option>
                        <option value="Pomfret">Pomfret</option>
                        <option value="Prawns">Prawns</option>
                        <option value="Crab">Crab</option>
                        <option value="Singhara">Singhara</option>
                        <option value="Trout">Trout</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group" id="custom-fish-type" style="display: none;">
                    <label>Custom Fish Name</label>
                    <input type="text" id="custom-fish-name" class="form-control" placeholder="Enter fish name">
                </div>

                <div class="form-group" style="display: flex; gap: 8px;">
                    <div style="flex: 1;">
                        <label>Weight (kg) *</label>
                        <input type="number" id="item-weight" class="form-control" placeholder="0.0" step="0.1" min="0.1">
                    </div>
                    <div style="flex: 1;">
                        <label>Price per kg (Rs.) *</label>
                        <input type="number" id="item-price" class="form-control" placeholder="0.00" step="0.01">
                    </div>
                </div>

                <button class="btn btn-warning" onclick="addFishItem()">
                    <i class="fas fa-plus"></i> Add Fish Item
                </button>

                <div class="invoice-items" id="invoice-items-list">
                    <!-- Fish items will be added here -->
                </div>

                <h4 class="section-title">Additional Expenses</h4>
                
                <div class="form-group" style="display: flex; gap: 8px;">
                    <div style="flex: 2;">
                        <label>Expense Description</label>
                        <input type="text" id="expense-description" class="form-control" placeholder="e.g., Labor, Transport, Packaging">
                    </div>
                    <div style="flex: 1;">
                        <label>Amount (Rs.)</label>
                        <input type="number" id="expense-amount" class="form-control" placeholder="0.00" step="0.01">
                    </div>
                </div>

                <button class="btn btn-warning" onclick="addExpenseItem()">
                    <i class="fas fa-plus"></i> Add Expense
                </button>

                <div class="invoice-items" id="expense-items-list">
                    <!-- Expense items will be added here -->
                </div>

                <div class="total-amount" id="invoice-total">
                    Total: Rs. 0.00
                </div>

                <div class="payment-section">
                    <div class="payment-explanation">
                        <h4>Payment Status Guide:</h4>
                        <ul>
                            <li><strong>Pending:</strong> Customer hasn't paid anything yet</li>
                            <li><strong>Partial:</strong> Customer paid some amount but not full</li>
                            <li><strong>Paid:</strong> Customer paid full amount</li>
                        </ul>
                    </div>

                    <div class="form-group">
                        <label>Payment Status *</label>
                        <select id="invoice-status" class="form-control" onchange="togglePaymentFields()">
                            <option value="pending">Pending (Not Paid)</option>
                            <option value="partial">Partial Payment</option>
                            <option value="paid">Paid (Full Payment)</option>
                        </select>
                    </div>

                    <div id="partial-payment-fields" class="hidden">
                        <div class="form-group">
                            <label>Amount Paid (Rs.) *</label>
                            <input type="number" id="amount-paid" class="form-control" placeholder="0.00" step="0.01" oninput="calculateRemaining()">
                        </div>
                        <div class="form-group">
                            <label>Remaining Amount</label>
                            <div id="remaining-amount" style="padding: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; font-weight: bold;">
                                Rs. 0.00
                            </div>
                        </div>
                    </div>

                    <div id="paid-payment-fields" class="hidden">
                        <div class="form-group">
                            <label>Full Amount Paid</label>
                            <div style="padding: 8px; background: rgba(39, 174, 96, 0.2); border-radius: 4px; font-weight: bold; color: var(--success);">
                                Rs. <span id="full-amount">0.00</span> (Full Payment Received)
                            </div>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn" onclick="hideCreateInvoiceForm()">Cancel</button>
                    <button class="btn btn-success" onclick="saveInvoice()">Save Invoice</button>
                </div>
            </div>

            <!-- Edit Invoice Form -->
            <div id="edit-invoice-form" class="hidden">
                <button class="back-btn" onclick="hideEditInvoiceForm()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <h3 style="margin-bottom: 15px;">Edit Invoice #<span id="edit-invoice-id"></span></h3>
                
                <div class="form-group">
                    <label>Select Shop *</label>
                    <select id="edit-invoice-shop" class="form-control" disabled>
                        <option value="">Select Shop</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Customer</label>
                    <input type="text" id="edit-invoice-customer" class="form-control" disabled>
                </div>

                <div class="form-group">
                    <label>Customer Balance</label>
                    <div id="edit-customer-balance-display" style="padding: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; border: 1px solid var(--dark-border);">
                        Loading...
                    </div>
                </div>

                <h4 class="section-title">Fish Items</h4>
                
                <div id="edit-fish-items-list">
                    <!-- Fish items for editing will appear here -->
                </div>

                <h4 class="section-title">Additional Expenses</h4>
                
                <div id="edit-expense-items-list">
                    <!-- Expense items for editing will appear here -->
                </div>

                <div class="total-amount" id="edit-invoice-total">
                    Total: Rs. 0.00
                </div>

                <div class="payment-section">
                    <div class="form-group">
                        <label>Update Payment Status</label>
                        <select id="edit-invoice-status" class="form-control" onchange="toggleEditPaymentFields()">
                            <option value="pending">Pending (Not Paid)</option>
                            <option value="partial">Partial Payment</option>
                            <option value="paid">Paid (Full Payment)</option>
                        </select>
                    </div>

                    <div id="edit-partial-payment-fields" class="hidden">
                        <div class="form-group">
                            <label>Additional Amount Paid (Rs.)</label>
                            <input type="number" id="edit-additional-paid" class="form-control" placeholder="0.00" step="0.01" oninput="calculateEditRemaining()">
                        </div>
                        <div class="form-group">
                            <label>Total Paid Amount</label>
                            <div id="edit-total-paid" style="padding: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; font-weight: bold;">
                                Rs. 0.00
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Remaining Amount</label>
                            <div id="edit-remaining-amount" style="padding: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; font-weight: bold;">
                                Rs. 0.00
                            </div>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn" onclick="hideEditInvoiceForm()">Cancel</button>
                    <button class="btn btn-success" onclick="updateInvoice()">Update Invoice</button>
                </div>
            </div>
        </div>

        <!-- Customers Tab -->
        <div class="tab-content" id="customers-tab">
            <div id="customers-main">
                <div class="tab-header">
                    <button class="btn btn-success btn-sm" onclick="showAddCustomerForm()">
                        <i class="fas fa-user-plus"></i> Add Customer
                    </button>
                    <div class="search-box">
                        <input type="text" id="customer-search" placeholder="Search customers..." onkeyup="searchCustomers()">
                    </div>
                </div>
                <div id="customers-list" class="customer-list">
                    <!-- Customers will be loaded here -->
                </div>
            </div>

            <div id="add-customer-form" class="hidden">
                <button class="back-btn" onclick="hideAddCustomerForm()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <h3 style="margin-bottom: 15px;">Add New Customer</h3>
                <div class="form-group">
                    <label>Select Shop *</label>
                    <select id="customer-shop" class="form-control">
                        <option value="">Select Shop</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Customer Name *</label>
                    <input type="text" id="customer-name" class="form-control" placeholder="Enter customer name">
                </div>
                <div class="form-group">
                    <label>Phone Number *</label>
                    <input type="tel" id="customer-phone" class="form-control" placeholder="Enter phone number">
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <textarea id="customer-address" class="form-control" placeholder="Enter address" rows="2"></textarea>
                </div>
                <div class="action-buttons">
                    <button class="btn" onclick="hideAddCustomerForm()">Cancel</button>
                    <button class="btn btn-success" onclick="saveCustomer()">Save Customer</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Simple Data Storage - 100% Working
        class DataStorage {
            static getShops() {
                try {
                    return JSON.parse(localStorage.getItem('qazi_shops')) || [];
                } catch {
                    return [];
                }
            }

            static saveShops(shops) {
                localStorage.setItem('qazi_shops', JSON.stringify(shops));
            }

            static getCustomers() {
                try {
                    return JSON.parse(localStorage.getItem('qazi_customers')) || [];
                } catch {
                    return [];
                }
            }

            static saveCustomers(customers) {
                localStorage.setItem('qazi_customers', JSON.stringify(customers));
            }

            static getInvoices() {
                try {
                    return JSON.parse(localStorage.getItem('qazi_invoices')) || [];
                } catch {
                    return [];
                }
            }

            static saveInvoices(invoices) {
                localStorage.setItem('qazi_invoices', JSON.stringify(invoices));
            }
        }

        // Main App - Complete Working Solution
        class QaziFishTradersApp {
            constructor() {
                this.shops = [];
                this.customers = [];
                this.invoices = [];
                this.currentShop = null;
                this.currentInvoiceItems = [];
                this.currentExpenseItems = [];
                this.editingShopId = null;
                this.editingInvoiceId = null;
                
                this.init();
            }

            init() {
                console.log("App initializing...");
                this.loadData();
                this.setupEventListeners();
                this.renderAll();
                this.showNotification("Complete Fish Business App loaded successfully!");
            }

            loadData() {
                console.log("Loading data...");
                this.shops = DataStorage.getShops();
                this.customers = DataStorage.getCustomers();
                this.invoices = DataStorage.getInvoices();
                console.log("Data loaded:", {
                    shops: this.shops.length,
                    customers: this.customers.length,
                    invoices: this.invoices.length
                });
            }

            setupEventListeners() {
                // Tab navigation
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const tabName = e.currentTarget.getAttribute('data-tab');
                        this.switchTab(tabName);
                    });
                });

                // Fish type change
                document.getElementById('fish-type')?.addEventListener('change', (e) => {
                    this.toggleCustomFishField(e.target.value);
                });
            }

            toggleCustomFishField(fishType) {
                const customField = document.getElementById('custom-fish-type');
                if (fishType === 'Other') {
                    customField.style.display = 'block';
                } else {
                    customField.style.display = 'none';
                }
            }

            switchTab(tabName) {
                console.log("Switching to tab:", tabName);
                
                // Update active tab
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

                // Update active content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabName}-tab`).classList.add('active');

                // Refresh data for the tab
                this.renderAll();
            }

            renderAll() {
                console.log("Rendering all data...");
                this.renderShops();
                this.renderCustomers();
                this.renderInvoices();
                this.updateDashboard();
                this.populateShopDropdowns();
            }

            populateShopDropdowns() {
                console.log("Populating shop dropdowns...");
                
                // Customer form shop dropdown
                const customerShopSelect = document.getElementById('customer-shop');
                if (customerShopSelect) {
                    customerShopSelect.innerHTML = '<option value="">Select Shop</option>' +
                        this.shops.map(shop => 
                            `<option value="${shop.id}">${this.escapeHtml(shop.name)}</option>`
                        ).join('');
                }

                // Invoice form shop dropdown
                const invoiceShopSelect = document.getElementById('invoice-shop');
                if (invoiceShopSelect) {
                    invoiceShopSelect.innerHTML = '<option value="">Select Shop</option>' +
                        this.shops.map(shop => 
                            `<option value="${shop.id}">${this.escapeHtml(shop.name)}</option>`
                        ).join('');
                    
                    // Auto-select current shop
                    if (this.currentShop) {
                        invoiceShopSelect.value = this.currentShop.id;
                        this.loadShopCustomers();
                    }
                }
            }

            loadShopCustomers() {
                const shopId = document.getElementById('invoice-shop').value;
                const customerSelect = document.getElementById('invoice-customer');
                
                console.log("Loading customers for shop:", shopId);
                
                if (shopId) {
                    const shopCustomers = this.customers.filter(customer => customer.shopId == shopId);
                    customerSelect.innerHTML = '<option value="">Select Customer</option>' +
                        shopCustomers.map(customer => 
                            `<option value="${customer.id}">${this.escapeHtml(customer.name)} - ${customer.phone}</option>`
                        ).join('');
                } else {
                    customerSelect.innerHTML = '<option value="">Select Customer</option>';
                }
                
                this.loadCustomerDetails();
                this.loadCustomerBalance();
            }

            loadCustomerDetails() {
                const customerId = document.getElementById('invoice-customer').value;
                const customerDetailsSection = document.getElementById('customer-details-section');
                const customerDetailsDisplay = document.getElementById('customer-details-display');
                
                if (customerId) {
                    const customer = this.customers.find(c => c.id == customerId);
                    if (customer) {
                        customerDetailsSection.classList.remove('hidden');
                        customerDetailsDisplay.innerHTML = `
                            <p><strong>Name:</strong> ${this.escapeHtml(customer.name)}</p>
                            <p><strong>Phone:</strong> ${this.escapeHtml(customer.phone)}</p>
                            ${customer.address ? `<p><strong>Address:</strong> ${this.escapeHtml(customer.address)}</p>` : ''}
                        `;
                        return;
                    }
                }
                
                customerDetailsSection.classList.add('hidden');
            }

            updateDashboard() {
                console.log("Updating dashboard...");
                
                const displayShops = this.currentShop ? [this.currentShop] : this.shops;
                const displayCustomers = this.currentShop ? 
                    this.customers.filter(c => c.shopId === this.currentShop.id) : this.customers;
                const displayInvoices = this.currentShop ? 
                    this.invoices.filter(i => i.shopId === this.currentShop.id) : this.invoices;
                
                document.getElementById('total-shops').textContent = displayShops.length;
                document.getElementById('total-customers').textContent = displayCustomers.length;
                document.getElementById('total-invoices').textContent = displayInvoices.length;
                
                const totalRevenue = displayInvoices.reduce((sum, invoice) => sum + invoice.totalAmount, 0);
                document.getElementById('total-revenue').textContent = `Rs. ${totalRevenue}`;

                this.renderRecentInvoices();
                this.renderPendingPayments();
            }

            renderRecentInvoices() {
                const recentInvoices = document.getElementById('recent-invoices');
                const displayInvoices = this.currentShop ? 
                    this.invoices.filter(i => i.shopId === this.currentShop.id) : this.invoices;
                
                const recent = displayInvoices.slice(-3).reverse();
                
                if (recent.length === 0) {
                    recentInvoices.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-receipt"></i>
                            <p>No invoices yet</p>
                        </div>
                    `;
                    return;
                }

                recentInvoices.innerHTML = recent.map(invoice => {
                    const shop = this.shops.find(s => s.id === invoice.shopId);
                    const statusClass = invoice.paid ? 'status-paid' : 
                                      (invoice.status === 'partial' ? 'status-partial' : 'status-pending');
                    const statusText = invoice.paid ? 'Paid' : 
                                     (invoice.status === 'partial' ? 'Partial' : 'Pending');
                    
                    return `
                        <div style="padding: 8px; border-bottom: 1px solid var(--dark-border);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${this.escapeHtml(invoice.customerName)}</strong>
                                    <div style="font-size: 0.7rem; color: var(--text-secondary);">
                                        ${new Date(invoice.date).toLocaleDateString()} â€¢ Rs. ${invoice.totalAmount}
                                        ${shop && !this.currentShop ? `<span class="shop-badge">${shop.name}</span>` : ''}
                                    </div>
                                </div>
                                <span class="status-badge ${statusClass}">
                                    ${statusText}
                                </span>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            renderPendingPayments() {
                const pendingPayments = document.getElementById('pending-payments');
                const displayInvoices = this.currentShop ? 
                    this.invoices.filter(i => i.shopId === this.currentShop.id) : this.invoices;
                
                const pending = displayInvoices.filter(inv => !inv.paid);
                
                if (pending.length === 0) {
                    pendingPayments.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-clock"></i>
                            <p>No pending payments</p>
                        </div>
                    `;
                    return;
                }

                const totalPending = pending.reduce((sum, inv) => sum + inv.remainingAmount, 0);
                
                pendingPayments.innerHTML = `
                    <div style="text-align: center; margin-bottom: 12px;">
                        <div style="font-size: 1.3rem; font-weight: bold; color: var(--accent);">
                            Rs. ${totalPending}
                        </div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Total Pending</div>
                    </div>
                    ${pending.slice(0, 3).map(invoice => {
                        const shop = this.shops.find(s => s.id === invoice.shopId);
                        const statusText = invoice.status === 'partial' ? 'Partial' : 'Pending';
                        
                        return `
                            <div style="padding: 6px; border-bottom: 1px solid var(--dark-border); font-size: 0.8rem;">
                                <strong>${this.escapeHtml(invoice.customerName)}</strong>
                                ${shop && !this.currentShop ? `<div style="font-size: 0.6rem; color: var(--secondary);">${shop.name}</div>` : ''}
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Rs. ${invoice.remainingAmount} (${statusText})</span>
                                    <span>${new Date(invoice.date).toLocaleDateString()}</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                `;
            }

            renderShops() {
                const shopsList = document.getElementById('shops-list');
                
                if (this.shops.length === 0) {
                    shopsList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-store"></i>
                            <h3>No Shops Added</h3>
                            <p>Add your first shop to get started</p>
                        </div>
                    `;
                    return;
                }

                shopsList.innerHTML = this.shops.map(shop => {
                    const shopCustomers = this.customers.filter(customer => customer.shopId === shop.id);
                    const shopInvoices = this.invoices.filter(invoice => invoice.shopId === shop.id);
                    const shopRevenue = shopInvoices.reduce((sum, inv) => sum + inv.totalAmount, 0);
                    const pendingAmount = shopInvoices.filter(inv => !inv.paid).reduce((sum, inv) => sum + inv.remainingAmount, 0);
                    
                    return `
                        <div class="card">
                            <h3>${this.escapeHtml(shop.name)}</h3>
                            <p><strong>Owner:</strong> ${this.escapeHtml(shop.owner)}</p>
                            <p><strong>Phone:</strong> ${this.escapeHtml(shop.phone)}</p>
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <div class="stat-value">${shopCustomers.length}</div>
                                    <div class="stat-label">Customers</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${shopInvoices.length}</div>
                                    <div class="stat-label">Invoices</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">Rs. ${shopRevenue}</div>
                                    <div class="stat-label">Revenue</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">Rs. ${pendingAmount}</div>
                                    <div class="stat-label">Pending</div>
                                </div>
                            </div>
                            <div class="action-buttons">
                                <button class="btn btn-sm ${this.currentShop?.id === shop.id ? 'btn-success' : ''}" onclick="app.selectShop(${shop.id})">
                                    ${this.currentShop?.id === shop.id ? 'âœ“ Selected' : 'Select Shop'}
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="app.editShop(${shop.id})">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="app.createShopInvoice(${shop.id})">
                                    <i class="fas fa-receipt"></i> New Invoice
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            renderCustomers() {
                const customersList = document.getElementById('customers-list');
                const displayCustomers = this.currentShop ? 
                    this.customers.filter(c => c.shopId === this.currentShop.id) : this.customers;
                
                if (displayCustomers.length === 0) {
                    customersList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h3>No Customers ${this.currentShop ? 'for this shop' : 'added'}</h3>
                            <p>Add your first customer to start</p>
                        </div>
                    `;
                    return;
                }

                if (!this.currentShop) {
                    let html = '';
                    this.shops.forEach(shop => {
                        const shopCustomers = this.customers.filter(customer => customer.shopId === shop.id);
                        if (shopCustomers.length > 0) {
                            html += `<div style="background: var(--primary); color: white; padding: 8px; margin: 10px 0; border-radius: 6px; text-align: center; font-weight: bold;">${shop.name} - ${shopCustomers.length} customers</div>`;
                            html += shopCustomers.map(customer => this.renderCustomerCard(customer)).join('');
                        }
                    });
                    customersList.innerHTML = html;
                } else {
                    customersList.innerHTML = displayCustomers.map(customer => this.renderCustomerCard(customer)).join('');
                }
            }

            renderCustomerCard(customer) {
                const shop = this.shops.find(s => s.id === customer.shopId);
                const customerInvoices = this.invoices.filter(inv => inv.customerId === customer.id);
                const totalPaid = customerInvoices.reduce((sum, inv) => sum + inv.amountPaid, 0);
                const totalPending = customerInvoices.reduce((sum, inv) => sum + inv.remainingAmount, 0);
                
                return `
                    <div class="card">
                        <h3>${this.escapeHtml(customer.name)} 
                            ${shop && !this.currentShop ? `<span class="shop-badge">${shop.name}</span>` : ''}
                        </h3>
                        <p><strong>Phone:</strong> ${this.escapeHtml(customer.phone)}</p>
                        ${customer.address ? `<p><strong>Address:</strong> ${this.escapeHtml(customer.address)}</p>` : ''}
                        <div class="payment-history">
                            <p><strong>Payment Summary:</strong></p>
                            <div class="payment-item">
                                <span>Total Paid:</span>
                                <span class="amount-positive">Rs. ${totalPaid}</span>
                            </div>
                            <div class="payment-item">
                                <span>Pending Amount:</span>
                                <span class="amount-negative">Rs. ${totalPending}</span>
                            </div>
                            <div class="payment-item">
                                <span>Overall Balance:</span>
                                <span class="${customer.balance >= 0 ? 'amount-positive' : 'amount-negative'}">
                                    Rs. ${customer.balance}
                                </span>
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-success" onclick="app.createInvoiceForCustomer(${customer.id})">
                                <i class="fas fa-receipt"></i> New Invoice
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="app.addPayment(${customer.id})">
                                <i class="fas fa-money-bill"></i> Payment
                            </button>
                        </div>
                    </div>
                `;
            }

            renderInvoices() {
                const invoicesList = document.getElementById('invoices-list');
                const displayInvoices = this.currentShop ? 
                    this.invoices.filter(i => i.shopId === this.currentShop.id) : this.invoices;
                
                if (displayInvoices.length === 0) {
                    invoicesList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-receipt"></i>
                            <h3>No Invoices ${this.currentShop ? 'for this shop' : 'created'}</h3>
                            <p>Create your first invoice</p>
                        </div>
                    `;
                    return;
                }

                if (!this.currentShop) {
                    let html = '';
                    this.shops.forEach(shop => {
                        const shopInvoices = this.invoices.filter(invoice => invoice.shopId === shop.id);
                        if (shopInvoices.length > 0) {
                            html += `<div style="background: var(--primary); color: white; padding: 8px; margin: 10px 0; border-radius: 6px; text-align: center; font-weight: bold;">${shop.name} - ${shopInvoices.length} invoices</div>`;
                            html += shopInvoices.slice().reverse().map(invoice => this.renderInvoiceCard(invoice)).join('');
                        }
                    });
                    invoicesList.innerHTML = html;
                } else {
                    invoicesList.innerHTML = displayInvoices.slice().reverse().map(invoice => this.renderInvoiceCard(invoice)).join('');
                }
            }

            renderInvoiceCard(invoice) {
                const shop = this.shops.find(s => s.id === invoice.shopId);
                const statusClass = invoice.paid ? 'status-paid' : 
                                  (invoice.status === 'partial' ? 'status-partial' : 'status-pending');
                const statusText = invoice.paid ? 'Paid' : 
                                 (invoice.status === 'partial' ? 'Partial' : 'Pending');
                
                return `
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h3>Invoice #${invoice.id}</h3>
                                <p><strong>Customer:</strong> ${this.escapeHtml(invoice.customerName)}</p>
                                ${shop && !this.currentShop ? `<p><strong>Shop:</strong> ${shop.name}</p>` : ''}
                                <p><strong>Date:</strong> ${new Date(invoice.date).toLocaleDateString()}</p>
                            </div>
                            <span class="status-badge ${statusClass}">
                                ${statusText}
                            </span>
                        </div>
                        <p><strong>Amount:</strong> Rs. ${invoice.totalAmount}</p>
                        <p><strong>Fish Items:</strong> ${invoice.items.length} types</p>
                        ${invoice.expenses && invoice.expenses.length > 0 ? `<p><strong>Expenses:</strong> ${invoice.expenses.length} items</p>` : ''}
                        <div class="payment-item">
                            <span>Paid:</span>
                            <span class="amount-positive">Rs. ${invoice.amountPaid}</span>
                        </div>
                        <div class="payment-item">
                            <span>Remaining:</span>
                            <span class="amount-negative">Rs. ${invoice.remainingAmount}</span>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-sm" onclick="app.viewInvoice(${invoice.id})">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="app.editInvoice(${invoice.id})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="app.printInvoice(${invoice.id})">
                                <i class="fas fa-print"></i> Print
                            </button>
                            <button class="btn btn-sm" style="background: #25D366;" onclick="app.shareToWhatsApp(${invoice.id})">
                                <i class="fab fa-whatsapp"></i> Share
                            </button>
                            ${!invoice.paid ? `
                                <button class="btn btn-sm btn-success" onclick="app.markAsPaid(${invoice.id})">
                                    <i class="fas fa-check"></i> Paid
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            selectShop(shopId) {
                console.log("Selecting shop:", shopId);
                this.currentShop = this.shops.find(shop => shop.id === shopId);
                this.updateCurrentShopDisplay();
                this.showNotification(`Selected shop: ${this.currentShop.name}`);
                this.renderAll();
            }

            clearShopSelection() {
                this.currentShop = null;
                this.updateCurrentShopDisplay();
                this.showNotification('Viewing all shops');
                this.renderAll();
            }

            updateCurrentShopDisplay() {
                const display = document.getElementById('current-shop-display');
                if (this.currentShop) {
                    display.innerHTML = `
                        <i class="fas fa-store"></i> ${this.escapeHtml(this.currentShop.name)}
                        <button onclick="app.clearShopSelection()" style="margin-left: 8px; background: none; border: none; color: white; cursor: pointer;">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                } else {
                    display.innerHTML = '<i class="fas fa-store"></i> Viewing all shops';
                }
            }

            addShop(shopData) {
                console.log("Adding shop:", shopData);
                const newShop = {
                    id: Date.now(),
                    ...shopData,
                    createdAt: new Date().toISOString()
                };
                this.shops.push(newShop);
                DataStorage.saveShops(this.shops);
                this.renderShops();
                this.updateDashboard();
                this.populateShopDropdowns();
                this.showNotification('Shop added successfully!');
                
                if (this.shops.length === 1) {
                    this.selectShop(newShop.id);
                }
            }

            editShop(shopId) {
                const shop = this.shops.find(s => s.id === shopId);
                if (!shop) return;

                this.editingShopId = shopId;
                
                // Populate edit form
                document.getElementById('edit-shop-name').value = shop.name;
                document.getElementById('edit-shop-owner').value = shop.owner;
                document.getElementById('edit-shop-phone').value = shop.phone;
                document.getElementById('edit-shop-address').value = shop.address || '';
                
                // Update logo preview
                const logoPreview = document.getElementById('edit-logo-preview');
                if (shop.logo) {
                    logoPreview.innerHTML = `<img src="${shop.logo}" alt="Shop Logo">`;
                } else {
                    logoPreview.innerHTML = '<i class="fas fa-camera"></i> Click to upload logo';
                }
                
                // Update stamp preview
                const stampPreview = document.getElementById('edit-stamp-preview');
                if (shop.stamp) {
                    stampPreview.innerHTML = `<img src="${shop.stamp}" alt="Shop Stamp">`;
                } else {
                    stampPreview.innerHTML = '<i class="fas fa-stamp"></i> Click to upload stamp';
                }
                
                // Show edit form
                document.getElementById('shops-main').classList.add('hidden');
                document.getElementById('edit-shop-form').classList.remove('hidden');
            }

            updateShop() {
                const shop = this.shops.find(s => s.id === this.editingShopId);
                if (!shop) return;

                shop.name = document.getElementById('edit-shop-name').value.trim();
                shop.owner = document.getElementById('edit-shop-owner').value.trim();
                shop.phone = document.getElementById('edit-shop-phone').value.trim();
                shop.address = document.getElementById('edit-shop-address').value.trim();

                // Logo and stamp are updated through file inputs
                
                DataStorage.saveShops(this.shops);
                this.renderShops();
                this.updateCurrentShopDisplay();
                this.showNotification('Shop updated successfully!');
                this.hideEditShopForm();
            }

            deleteShop(shopId) {
                if (!confirm('Are you sure you want to delete this shop? All customers and invoices for this shop will also be deleted.')) {
                    return;
                }

                // Delete shop
                this.shops = this.shops.filter(shop => shop.id !== shopId);
                
                // Delete shop's customers
                this.customers = this.customers.filter(customer => customer.shopId !== shopId);
                
                // Delete shop's invoices
                this.invoices = this.invoices.filter(invoice => invoice.shopId !== shopId);
                
                DataStorage.saveShops(this.shops);
                DataStorage.saveCustomers(this.customers);
                DataStorage.saveInvoices(this.invoices);
                
                if (this.currentShop && this.currentShop.id === shopId) {
                    this.currentShop = null;
                }
                
                this.renderAll();
                this.showNotification('Shop deleted successfully!');
            }

            hideEditShopForm() {
                document.getElementById('shops-main').classList.remove('hidden');
                document.getElementById('edit-shop-form').classList.add('hidden');
                this.editingShopId = null;
            }

            addCustomer(customerData) {
                console.log("Adding customer:", customerData);
                const newCustomer = {
                    id: Date.now(),
                    ...customerData,
                    shopId: parseInt(customerData.shopId),
                    balance: 0,
                    createdAt: new Date().toISOString()
                };
                this.customers.push(newCustomer);
                DataStorage.saveCustomers(this.customers);
                this.renderCustomers();
                this.updateDashboard();
                this.showNotification('Customer added successfully!');
            }

            // FIXED: addInvoice method with correct payment calculations
            addInvoice(invoiceData) {
                console.log("Adding invoice:", invoiceData);
                
                // Calculate totals
                const fishTotal = invoiceData.items.reduce((sum, item) => sum + item.total, 0);
                const expenseTotal = (invoiceData.expenses || []).reduce((sum, expense) => sum + expense.amount, 0);
                const totalAmount = fishTotal + expenseTotal;
                
                let amountPaid = invoiceData.amountPaid || 0;
                let remainingAmount = totalAmount - amountPaid;
                let paid = false;
                let status = invoiceData.status;

                // Determine payment status correctly
                if (status === 'paid') {
                    paid = true;
                    amountPaid = totalAmount;
                    remainingAmount = 0;
                } else if (status === 'partial') {
                    paid = false;
                    // amountPaid and remainingAmount are already calculated above
                    if (amountPaid <= 0) {
                        status = 'pending';
                        amountPaid = 0;
                        remainingAmount = totalAmount;
                    }
                } else { // pending
                    paid = false;
                    amountPaid = 0;
                    remainingAmount = totalAmount;
                }

                const newInvoice = {
                    id: Date.now(),
                    ...invoiceData,
                    shopId: parseInt(invoiceData.shopId),
                    date: new Date().toISOString(),
                    totalAmount: totalAmount,
                    amountPaid: amountPaid,
                    remainingAmount: remainingAmount,
                    paid: paid,
                    status: status,
                    expenses: invoiceData.expenses || []
                };
                
                this.invoices.push(newInvoice);
                DataStorage.saveInvoices(this.invoices);

                // Update customer balance - only add pending amount to customer's debt
                if (!paid && remainingAmount > 0) {
                    this.updateCustomerBalance(invoiceData.customerId, remainingAmount);
                }

                this.renderInvoices();
                this.updateDashboard();
                this.showNotification('Professional fish invoice created successfully!');
            }

            updateCustomerBalance(customerId, amount) {
                const customer = this.customers.find(c => c.id === customerId);
                if (customer) {
                    customer.balance = (customer.balance || 0) + amount;
                    DataStorage.saveCustomers(this.customers);
                    this.renderCustomers();
                    console.log(`Updated customer ${customer.name} balance: ${customer.balance}`);
                }
            }

            addPaymentToCustomer(customerId, amount) {
                const customer = this.customers.find(c => c.id === customerId);
                if (customer) {
                    // Find all pending invoices for this customer
                    const pendingInvoices = this.invoices.filter(inv => 
                        inv.customerId === customerId && !inv.paid
                    );
                    
                    // Apply payment to the oldest pending invoice first
                    let remainingPayment = amount;
                    for (let invoice of pendingInvoices) {
                        if (remainingPayment <= 0) break;
                        
                        const paymentApplied = Math.min(remainingPayment, invoice.remainingAmount);
                        invoice.amountPaid += paymentApplied;
                        invoice.remainingAmount -= paymentApplied;
                        
                        if (invoice.remainingAmount === 0) {
                            invoice.paid = true;
                            invoice.status = 'paid';
                        } else {
                            invoice.status = 'partial';
                        }
                        
                        remainingPayment -= paymentApplied;
                    }
                    
                    // Update customer balance
                    customer.balance -= amount;
                    
                    // Save changes
                    DataStorage.saveInvoices(this.invoices);
                    DataStorage.saveCustomers(this.customers);
                    
                    this.showNotification(`Payment of Rs. ${amount} recorded!`);
                    this.renderCustomers();
                    this.renderInvoices();
                    this.updateDashboard();
                }
            }

            // FIXED: markAsPaid function
            markAsPaid(invoiceId) {
                console.log("Marking invoice as paid:", invoiceId);
                const invoice = this.invoices.find(inv => inv.id === invoiceId);
                if (invoice && !invoice.paid) {
                    const remainingBefore = invoice.remainingAmount;
                    
                    invoice.paid = true;
                    invoice.status = 'paid';
                    invoice.amountPaid = invoice.totalAmount;
                    invoice.remainingAmount = 0;
                    
                    DataStorage.saveInvoices(this.invoices);
                    
                    // Update customer balance (reduce debt)
                    this.updateCustomerBalance(invoice.customerId, -remainingBefore);
                    
                    this.renderInvoices();
                    this.updateDashboard();
                    this.showNotification('Invoice marked as paid!');
                } else if (invoice && invoice.paid) {
                    this.showNotification('Invoice is already paid!');
                }
            }

            editInvoice(invoiceId) {
                const invoice = this.invoices.find(inv => inv.id === invoiceId);
                if (!invoice) return;

                this.editingInvoiceId = invoiceId;
                
                // Populate edit form
                document.getElementById('edit-invoice-id').textContent = invoiceId;
                document.getElementById('edit-invoice-shop').value = invoice.shopId;
                document.getElementById('edit-invoice-customer').value = invoice.customerName;
                
                // Load customer balance
                const customer = this.customers.find(c => c.id === invoice.customerId);
                if (customer) {
                    document.getElementById('edit-customer-balance-display').innerHTML = `
                        <span class="${customer.balance >= 0 ? 'amount-positive' : 'amount-negative'}">
                            <i class="fas fa-wallet"></i> Current Balance: Rs. ${customer.balance}
                        </span>
                    `;
                }
                
                // Render fish items for editing
                this.renderEditFishItems(invoice.items);
                
                // Render expense items for editing
                this.renderEditExpenseItems(invoice.expenses || []);
                
                // Update payment status
                document.getElementById('edit-invoice-status').value = invoice.paid ? 'paid' : invoice.status;
                
                // Update payment fields
                document.getElementById('edit-total-paid').textContent = `Rs. ${invoice.amountPaid.toFixed(2)}`;
                document.getElementById('edit-remaining-amount').textContent = `Rs. ${invoice.remainingAmount.toFixed(2)}`;
                
                // Calculate and display total
                this.updateEditInvoiceTotal();
                
                // Show edit form
                document.getElementById('invoices-main').classList.add('hidden');
                document.getElementById('edit-invoice-form').classList.remove('hidden');
                this.toggleEditPaymentFields();
            }

            renderEditFishItems(items) {
                const container = document.getElementById('edit-fish-items-list');
                container.innerHTML = items.map((item, index) => `
                    <div class="fish-item">
                        <div class="item-details">
                            <strong>${this.escapeHtml(item.description)}</strong>
                            <div>${item.weight} @ Rs. ${item.price}/kg = Rs. ${item.total}</div>
                        </div>
                        <div class="item-actions">
                            <button class="btn btn-sm btn-danger" onclick="app.removeEditFishItem(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            renderEditExpenseItems(expenses) {
                const container = document.getElementById('edit-expense-items-list');
                container.innerHTML = expenses.map((expense, index) => `
                    <div class="expense-item">
                        <div class="item-details">
                            <strong>${this.escapeHtml(expense.description)}</strong>
                            <div>Rs. ${expense.amount}</div>
                        </div>
                        <div class="item-actions">
                            <button class="btn btn-sm btn-danger" onclick="app.removeEditExpenseItem(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            removeEditFishItem(index) {
                const invoice = this.invoices.find(inv => inv.id === this.editingInvoiceId);
                if (invoice) {
                    invoice.items.splice(index, 1);
                    this.renderEditFishItems(invoice.items);
                    this.updateEditInvoiceTotal();
                }
            }

            removeEditExpenseItem(index) {
                const invoice = this.invoices.find(inv => inv.id === this.editingInvoiceId);
                if (invoice) {
                    if (!invoice.expenses) invoice.expenses = [];
                    invoice.expenses.splice(index, 1);
                    this.renderEditExpenseItems(invoice.expenses);
                    this.updateEditInvoiceTotal();
                }
            }

            updateEditInvoiceTotal() {
                const invoice = this.invoices.find(inv => inv.id === this.editingInvoiceId);
                if (invoice) {
                    const fishTotal = invoice.items.reduce((sum, item) => sum + item.total, 0);
                    const expenseTotal = (invoice.expenses || []).reduce((sum, expense) => sum + expense.amount, 0);
                    const totalAmount = fishTotal + expenseTotal;
                    
                    invoice.totalAmount = totalAmount;
                    invoice.remainingAmount = totalAmount - invoice.amountPaid;
                    
                    document.getElementById('edit-invoice-total').textContent = `Total: Rs. ${totalAmount.toFixed(2)}`;
                    document.getElementById('edit-remaining-amount').textContent = `Rs. ${invoice.remainingAmount.toFixed(2)}`;
                }
            }

            updateInvoice() {
                const invoice = this.invoices.find(inv => inv.id === this.editingInvoiceId);
                if (!invoice) return;

                const status = document.getElementById('edit-invoice-status').value;
                const additionalPaid = parseFloat(document.getElementById('edit-additional-paid').value) || 0;
                
                // Update payment information
                if (additionalPaid > 0) {
                    const oldRemaining = invoice.remainingAmount;
                    invoice.amountPaid += additionalPaid;
                    invoice.remainingAmount = invoice.totalAmount - invoice.amountPaid;
                    
                    if (invoice.remainingAmount <= 0) {
                        invoice.paid = true;
                        invoice.status = 'paid';
                        invoice.remainingAmount = 0;
                        // Update customer balance for full payment
                        this.updateCustomerBalance(invoice.customerId, -oldRemaining);
                    } else {
                        invoice.paid = false;
                        invoice.status = 'partial';
                        // Update customer balance for partial payment
                        this.updateCustomerBalance(invoice.customerId, -additionalPaid);
                    }
                } else {
                    const oldRemaining = invoice.remainingAmount;
                    invoice.status = status;
                    invoice.paid = status === 'paid';
                    if (invoice.paid) {
                        invoice.amountPaid = invoice.totalAmount;
                        invoice.remainingAmount = 0;
                        // Update customer balance for marking as paid
                        this.updateCustomerBalance(invoice.customerId, -oldRemaining);
                    } else if (status === 'pending') {
                        invoice.amountPaid = 0;
                        invoice.remainingAmount = invoice.totalAmount;
                        // Update customer balance for reverting to pending
                        this.updateCustomerBalance(invoice.customerId, invoice.totalAmount);
                    }
                }
                
                DataStorage.saveInvoices(this.invoices);
                this.renderInvoices();
                this.updateDashboard();
                this.showNotification('Invoice updated successfully!');
                this.hideEditInvoiceForm();
            }

            hideEditInvoiceForm() {
                document.getElementById('invoices-main').classList.remove('hidden');
                document.getElementById('edit-invoice-form').classList.add('hidden');
                this.editingInvoiceId = null;
            }

            createInvoiceForCustomer(customerId) {
                this.switchTab('invoices');
                setTimeout(() => {
                    showCreateInvoiceForm();
                    const customer = this.customers.find(c => c.id === customerId);
                    if (customer) {
                        document.getElementById('invoice-shop').value = customer.shopId;
                        this.loadShopCustomers();
                        setTimeout(() => {
                            document.getElementById('invoice-customer').value = customerId;
                            this.loadCustomerDetails();
                            this.loadCustomerBalance();
                        }, 100);
                    }
                }, 100);
            }

            createShopInvoice(shopId) {
                this.switchTab('invoices');
                setTimeout(() => {
                    showCreateInvoiceForm();
                    document.getElementById('invoice-shop').value = shopId;
                    this.loadShopCustomers();
                }, 100);
            }

            addPayment(customerId) {
                const customer = this.customers.find(c => c.id === customerId);
                if (!customer) return;
                
                const pendingAmount = this.invoices
                    .filter(inv => inv.customerId === customerId && !inv.paid)
                    .reduce((sum, inv) => sum + inv.remainingAmount, 0);
                
                const amount = prompt(`Enter payment amount for ${customer.name}:\nPending Amount: Rs. ${pendingAmount}`);
                if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                    this.addPaymentToCustomer(customerId, parseFloat(amount));
                }
            }

            viewInvoice(invoiceId) {
                const invoice = this.invoices.find(inv => inv.id === invoiceId);
                if (invoice) {
                    const itemsHtml = invoice.items.map(item => `
                        <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid var(--dark-border);">
                            <div>${item.description} - ${item.weight} kg</div>
                            <div>Rs. ${item.price}/kg = Rs. ${item.total}</div>
                        </div>
                    `).join('');

                    const expensesHtml = (invoice.expenses || []).map(expense => `
                        <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid var(--dark-border);">
                            <div>${expense.description}</div>
                            <div>Rs. ${expense.amount}</div>
                        </div>
                    `).join('');

                    const shop = this.shops.find(s => s.id === invoice.shopId);
                    const customer = this.customers.find(c => c.id === invoice.customerId);
                    
                    alert(`PROFESSIONAL FISH INVOICE #${invoice.id}
Shop: ${shop ? shop.name : 'N/A'}
Customer: ${invoice.customerName}
Phone: ${customer ? customer.phone : 'N/A'}
Address: ${customer && customer.address ? customer.address : 'N/A'}
Date: ${new Date(invoice.date).toLocaleDateString()}
Status: ${invoice.paid ? 'Paid' : invoice.status}
Amount Paid: Rs. ${invoice.amountPaid}
Remaining Amount: Rs. ${invoice.remainingAmount}

FISH ITEMS:
${itemsHtml}

${expensesHtml ? `ADDITIONAL EXPENSES:\n${expensesHtml}` : ''}

TOTAL: Rs. ${invoice.totalAmount}`);
                }
            }

            generatePrintableInvoice(invoiceId) {
                const invoice = this.invoices.find(inv => inv.id === invoiceId);
                if (!invoice) return '';

                const shop = this.shops.find(s => s.id === invoice.shopId);
                const customer = this.customers.find(c => c.id === invoice.customerId);
                
                const itemsHtml = invoice.items.map(item => `
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 12px; font-weight: bold;">${item.description}</td>
                        <td style="border: 1px solid #ddd; padding: 12px; text-align: center; font-weight: bold;">${item.weight}</td>
                        <td style="border: 1px solid #ddd; padding: 12px; text-align: right; font-weight: bold;">Rs. ${item.price}/kg</td>
                        <td style="border: 1px solid #ddd; padding: 12px; text-align: right; font-weight: bold;">Rs. ${item.total}</td>
                    </tr>
                `).join('');

                const expensesHtml = (invoice.expenses || []).map(expense => `
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 12px; font-weight: bold;">${expense.description}</td>
                        <td style="border: 1px solid #ddd; padding: 12px; text-align: center; font-weight: bold;">-</td>
                        <td style="border: 1px solid #ddd; padding: 12px; text-align: right; font-weight: bold;">-</td>
                        <td style="border: 1px solid #ddd; padding: 12px; text-align: right; font-weight: bold;">Rs. ${expense.amount}</td>
                    </tr>
                `).join('');

                const statusColor = invoice.paid ? '#27ae60' : (invoice.status === 'partial' ? '#3498db' : '#e74c3c');
                const statusText = invoice.paid ? 'PAID' : (invoice.status === 'partial' ? 'PARTIAL PAYMENT' : 'PENDING');

                return `
                    <div style="font-family: 'Arial', sans-serif; max-width: 800px; margin: 0 auto; padding: 30px; background: white; color: black; border: 2px solid #2c3e50;">
                        <!-- Header with Logo -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 3px solid #2c3e50; padding-bottom: 20px;">
                            <div>
                                ${shop && shop.logo ? `
                                    <img src="${shop.logo}" alt="${shop.name}" style="max-height: 80px; max-width: 200px;">
                                ` : `
                                    <h1 style="color: #2c3e50; margin: 0; font-size: 28px; font-weight: bold;">QAZI FISH TRADERS</h1>
                                    <p style="color: #7f8c8d; margin: 5px 0; font-size: 16px; font-weight: bold;">Fresh Fish Wholesale & Retail | Professional Invoicing</p>
                                `}
                            </div>
                            <div style="text-align: right;">
                                <h2 style="color: #2c3e50; margin: 0; font-size: 24px; font-weight: bold;">PROFESSIONAL FISH INVOICE</h2>
                                <p style="color: #7f8c8d; margin: 5px 0; font-size: 16px; font-weight: bold;">#${invoice.id}</p>
                                <p style="color: ${statusColor}; margin: 5px 0; font-size: 14px; font-weight: bold; background: ${statusColor}20; padding: 5px 10px; border-radius: 4px; display: inline-block;">
                                    ${statusText}
                                </p>
                            </div>
                        </div>

                        <!-- Shop and Customer Details -->
                        <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
                            <div style="flex: 1;">
                                <h3 style="color: #2c3e50; margin-bottom: 15px; font-weight: bold; border-bottom: 2px solid #2c3e50; padding-bottom: 5px;">FROM:</h3>
                                <p style="margin: 8px 0; font-weight: bold; font-size: 16px;">${shop ? shop.name : 'Qazi Fish Traders'}</p>
                                ${shop && shop.owner ? `<p style="margin: 8px 0; font-weight: bold;">Proprietor: ${shop.owner}</p>` : ''}
                                ${shop && shop.address ? `<p style="margin: 8px 0; font-weight: bold;">${shop.address}</p>` : ''}
                                ${shop && shop.phone ? `<p style="margin: 8px 0; font-weight: bold;">Phone: ${shop.phone}</p>` : ''}
                            </div>
                            <div style="flex: 1; text-align: right;">
                                <h3 style="color: #2c3e50; margin-bottom: 15px; font-weight: bold; border-bottom: 2px solid #2c3e50; padding-bottom: 5px;">BILL TO:</h3>
                                <p style="margin: 8px 0; font-weight: bold; font-size: 16px;">${invoice.customerName}</p>
                                ${customer && customer.phone ? `<p style="margin: 8px 0; font-weight: bold;">Phone: ${customer.phone}</p>` : ''}
                                ${customer && customer.address ? `<p style="margin: 8px 0; font-weight: bold;">${customer.address}</p>` : ''}
                                <p style="margin: 8px 0; font-weight: bold;"><strong>Date:</strong> ${new Date(invoice.date).toLocaleDateString()}</p>
                            </div>
                        </div>

                        <!-- Fish Items Table -->
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px; border: 2px solid #2c3e50;">
                            <thead>
                                <tr style="background: #2c3e50; color: white;">
                                    <th style="padding: 15px; text-align: left; border: 1px solid #ddd; font-weight: bold; font-size: 16px;">Fish Type</th>
                                    <th style="padding: 15px; text-align: center; border: 1px solid #ddd; font-weight: bold; font-size: 16px;">Weight (kg)</th>
                                    <th style="padding: 15px; text-align: right; border: 1px solid #ddd; font-weight: bold; font-size: 16px;">Price/kg</th>
                                    <th style="padding: 15px; text-align: right; border: 1px solid #ddd; font-weight: bold; font-size: 16px;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHtml}
                                ${expensesHtml}
                                <tr style="background: #f8f9fa;">
                                    <td colspan="3" style="border: 1px solid #ddd; padding: 15px; text-align: right; font-weight: bold; font-size: 16px;">Total Amount:</td>
                                    <td style="border: 1px solid #ddd; padding: 15px; text-align: right; font-weight: bold; font-size: 16px;">Rs. ${invoice.totalAmount.toFixed(2)}</td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- Payment Summary -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; border: 2px solid #2c3e50;">
                            <h4 style="color: #2c3e50; margin-bottom: 15px; font-weight: bold; font-size: 18px;">PAYMENT SUMMARY</h4>
                            <div style="display: flex; justify-content: space-between;">
                                <div>
                                    <p style="margin: 10px 0; font-weight: bold;"><strong>Total Amount:</strong> Rs. ${invoice.totalAmount.toFixed(2)}</p>
                                    <p style="margin: 10px 0; font-weight: bold;"><strong>Amount Paid:</strong> Rs. ${invoice.amountPaid.toFixed(2)}</p>
                                    <p style="margin: 10px 0; font-weight: bold;"><strong>Remaining Balance:</strong> Rs. ${invoice.remainingAmount.toFixed(2)}</p>
                                </div>
                                <div style="text-align: right;">
                                    <p style="margin: 10px 0; font-weight: bold;"><strong>Status:</strong> ${invoice.paid ? 'PAID IN FULL' : invoice.status.toUpperCase()}</p>
                                    <p style="margin: 10px 0; font-weight: bold;"><strong>Invoice Date:</strong> ${new Date(invoice.date).toLocaleDateString()}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Total and Signature -->
                        <div style="display: flex; justify-content: space-between; align-items: end; margin-top: 40px;">
                            <div style="flex: 1;">
                                ${shop && shop.stamp ? `
                                    <div style="margin-top: 40px;">
                                        <img src="${shop.stamp}" alt="Authorized Stamp" style="max-height: 80px; max-width: 150px; opacity: 0.8;">
                                        <p style="margin: 5px 0; font-style: italic; font-weight: bold;">Authorized Signature</p>
                                    </div>
                                ` : `
                                    <div style="margin-top: 60px; border-top: 2px solid #2c3e50; width: 200px;">
                                        <p style="margin: 5px 0; font-style: italic; font-weight: bold;">Authorized Signature</p>
                                    </div>
                                `}
                            </div>
                            <div style="flex: 1; text-align: right;">
                                <div style="font-size: 22px; font-weight: bold; color: #2c3e50; margin-bottom: 15px; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 2px solid #2c3e50;">
                                    TOTAL AMOUNT: Rs. ${invoice.totalAmount.toFixed(2)}
                                </div>
                                <div style="font-size: 16px; color: #7f8c8d; font-weight: bold;">
                                    Thank you for your business!
                                </div>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div style="border-top: 3px solid #2c3e50; padding-top: 20px; text-align: center; color: #7f8c8d; margin-top: 40px;">
                            <p style="margin: 8px 0; font-weight: bold;">For any queries, please contact: ${shop ? shop.phone : 'Your Shop'}</p>
                            <p style="margin: 8px 0; font-size: 14px; font-weight: bold;">This is a computer-generated invoice</p>
                        </div>
                    </div>
                `;
            }

            printInvoice(invoiceId) {
                const printableContent = this.generatePrintableInvoice(invoiceId);
                if (!printableContent) return;

                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                        <head>
                            <title>Professional Fish Invoice #${invoiceId} - Qazi Fish Traders</title>
                            <style>
                                body { margin: 0; padding: 20px; background: white; }
                                @media print {
                                    body { margin: 0; }
                                    @page { margin: 0.5in; }
                                }
                            </style>
                        </head>
                        <body>
                            ${printableContent}
                            <script>
                                window.onload = function() {
                                    window.print();
                                    setTimeout(function() {
                                        window.close();
                                    }, 500);
                                };
                            <\/script>
                        </body>
                    </html>
                `);
                printWindow.document.close();
            }

            // FIXED: WhatsApp Sharing Function
            shareToWhatsApp(invoiceId) {
                const invoice = this.invoices.find(inv => inv.id === invoiceId);
                if (!invoice) return;

                // Create a printable invoice
                const printableContent = this.generatePrintableInvoice(invoiceId);
                
                // Create a temporary div to render the invoice
                const tempDiv = document.createElement('div');
                tempDiv.style.position = 'fixed';
                tempDiv.style.left = '-9999px';
                tempDiv.style.top = '0';
                tempDiv.style.width = '800px';
                tempDiv.innerHTML = printableContent;
                document.body.appendChild(tempDiv);
                
                // Use html2canvas to capture the invoice as image
                html2canvas(tempDiv, {
                    scale: 2,
                    useCORS: true,
                    logging: false
                }).then(canvas => {
                    // Convert canvas to data URL
                    const imageData = canvas.toDataURL('image/png');
                    
                    // Remove temporary div
                    document.body.removeChild(tempDiv);
                    
                    // Create WhatsApp message
                    const shop = this.shops.find(s => s.id === invoice.shopId);
                    const customer = this.customers.find(c => c.id === invoice.customerId);
                    
                    let message = `*Qazi Fish Traders - Professional Fish Invoice #${invoiceId}*\n\n`;
                    message += `*Shop:* ${shop ? shop.name : 'Qazi Fish Traders'}\n`;
                    message += `*Customer:* ${invoice.customerName}\n`;
                    message += `*Phone:* ${customer ? customer.phone : 'N/A'}\n`;
                    if (customer && customer.address) {
                        message += `*Address:* ${customer.address}\n`;
                    }
                    message += `*Date:* ${new Date(invoice.date).toLocaleDateString()}\n`;
                    message += `*Status:* ${invoice.paid ? 'Paid' : invoice.status}\n`;
                    message += `*Amount Paid:* Rs. ${invoice.amountPaid}\n`;
                    message += `*Remaining Amount:* Rs. ${invoice.remainingAmount}\n`;
                    message += `*Total Amount:* Rs. ${invoice.totalAmount}\n\n`;
                    message += `Please find the attached invoice for your reference.\n\n`;
                    message += `Thank you for your business!`;
                    
                    // For image sharing, we'll use text-only approach as WhatsApp Web API doesn't support image sharing directly
                    const encodedMessage = encodeURIComponent(message);
                    const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
                    
                    window.open(whatsappUrl, '_blank');
                    
                    this.showNotification('Invoice shared via WhatsApp!');
                }).catch(error => {
                    console.error('Error capturing invoice:', error);
                    document.body.removeChild(tempDiv);
                    
                    // Fallback to text sharing if image capture fails
                    this.shareToWhatsAppText(invoiceId);
                });
            }

            shareToWhatsAppText(invoiceId) {
                const invoice = this.invoices.find(inv => inv.id === invoiceId);
                if (!invoice) return;

                const shop = this.shops.find(s => s.id === invoice.shopId);
                const customer = this.customers.find(c => c.id === invoice.customerId);
                const total = invoice.totalAmount;
                const status = invoice.paid ? 'Paid' : invoice.status;
                
                let message = `*Qazi Fish Traders - Professional Fish Invoice #${invoiceId}*\n\n`;
                message += `*Shop:* ${shop ? shop.name : 'Qazi Fish Traders'}\n`;
                message += `*Customer:* ${invoice.customerName}\n`;
                message += `*Phone:* ${customer ? customer.phone : 'N/A'}\n`;
                if (customer && customer.address) {
                    message += `*Address:* ${customer.address}\n`;
                }
                message += `*Date:* ${new Date(invoice.date).toLocaleDateString()}\n`;
                message += `*Status:* ${status}\n`;
                message += `*Amount Paid:* Rs. ${invoice.amountPaid}\n`;
                message += `*Remaining Amount:* Rs. ${invoice.remainingAmount}\n`;
                message += `*Total Amount:* Rs. ${total}\n\n`;
                message += `*Fish Items:*\n`;
                
                invoice.items.forEach(item => {
                    message += `â€¢ ${item.description} - ${item.weight} @ Rs. ${item.price}/kg = Rs. ${item.total}\n`;
                });
                
                if (invoice.expenses && invoice.expenses.length > 0) {
                    message += `\n*Additional Expenses:*\n`;
                    invoice.expenses.forEach(expense => {
                        message += `â€¢ ${expense.description} - Rs. ${expense.amount}\n`;
                    });
                }
                
                message += `\nThank you for your business!`;
                
                const encodedMessage = encodeURIComponent(message);
                const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
                
                window.open(whatsappUrl, '_blank');
                this.showNotification('Invoice shared via WhatsApp!');
            }

            loadCustomerBalance() {
                const customerId = document.getElementById('invoice-customer').value;
                const balanceDisplay = document.getElementById('customer-balance-display');
                
                if (customerId) {
                    const customer = this.customers.find(c => c.id == customerId);
                    if (customer) {
                        balanceDisplay.innerHTML = `
                            <span class="${customer.balance >= 0 ? 'amount-positive' : 'amount-negative'}">
                                <i class="fas fa-wallet"></i> Current Balance: Rs. ${customer.balance}
                            </span>
                        `;
                        return;
                    }
                }
                
                balanceDisplay.innerHTML = '<i class="fas fa-user"></i> Select a customer to view balance';
            }

            showNotification(message) {
                const notification = document.createElement('div');
                notification.className = 'notification';
                notification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-check-circle"></i>
                        <span>${message}</span>
                    </div>
                `;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }

            escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }
        }

        // File handling functions
        function previewLogo(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    window.tempLogo = e.target.result;
                    event.target.previousElementSibling.innerHTML = `<img src="${e.target.result}" alt="Shop Logo">`;
                };
                reader.readAsDataURL(file);
            }
        }

        function previewStamp(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    window.tempStamp = e.target.result;
                    event.target.previousElementSibling.innerHTML = `<img src="${e.target.result}" alt="Shop Stamp">`;
                };
                reader.readAsDataURL(file);
            }
        }

        function previewEditLogo(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const shop = app.shops.find(s => s.id === app.editingShopId);
                    if (shop) {
                        shop.logo = e.target.result;
                        event.target.previousElementSibling.innerHTML = `<img src="${e.target.result}" alt="Shop Logo">`;
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        function previewEditStamp(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const shop = app.shops.find(s => s.id === app.editingShopId);
                    if (shop) {
                        shop.stamp = e.target.result;
                        event.target.previousElementSibling.innerHTML = `<img src="${e.target.result}" alt="Shop Stamp">`;
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        // FIXED: Payment calculation functions
        function togglePaymentFields() {
            const status = document.getElementById('invoice-status').value;
            const partialFields = document.getElementById('partial-payment-fields');
            const paidFields = document.getElementById('paid-payment-fields');
            
            // Calculate current total
            const fishTotal = app.currentInvoiceItems.reduce((sum, item) => sum + item.total, 0);
            const expenseTotal = app.currentExpenseItems.reduce((sum, expense) => sum + expense.amount, 0);
            const totalAmount = fishTotal + expenseTotal;
            
            // Hide all fields first
            partialFields.classList.add('hidden');
            paidFields.classList.add('hidden');
            
            // Clear amount paid field
            document.getElementById('amount-paid').value = '';
            
            if (status === 'partial') {
                partialFields.classList.remove('hidden');
                calculateRemaining();
            } else if (status === 'paid') {
                paidFields.classList.remove('hidden');
                document.getElementById('full-amount').textContent = totalAmount.toFixed(2);
                document.getElementById('amount-paid').value = totalAmount.toFixed(2);
                calculateRemaining();
            } else {
                // Pending - ensure amount paid is 0
                document.getElementById('amount-paid').value = '0';
                calculateRemaining();
            }
        }

        function toggleEditPaymentFields() {
            const status = document.getElementById('edit-invoice-status').value;
            const partialFields = document.getElementById('edit-partial-payment-fields');
            
            if (status === 'partial') {
                partialFields.classList.remove('hidden');
                calculateEditRemaining();
            } else {
                partialFields.classList.add('hidden');
            }
        }

        function calculateRemaining() {
            const fishTotal = app.currentInvoiceItems.reduce((sum, item) => sum + item.total, 0);
            const expenseTotal = app.currentExpenseItems.reduce((sum, expense) => sum + expense.amount, 0);
            const total = fishTotal + expenseTotal;
            const amountPaid = parseFloat(document.getElementById('amount-paid').value) || 0;
            const remaining = Math.max(0, total - amountPaid);
            
            document.getElementById('remaining-amount').textContent = `Rs. ${remaining.toFixed(2)}`;
            document.getElementById('remaining-amount').className = remaining > 0 ? 'amount-negative' : 'amount-positive';
        }

        function calculateEditRemaining() {
            const invoice = app.invoices.find(inv => inv.id === app.editingInvoiceId);
            if (invoice) {
                const additionalPaid = parseFloat(document.getElementById('edit-additional-paid').value) || 0;
                const totalPaid = invoice.amountPaid + additionalPaid;
                const remaining = invoice.totalAmount - totalPaid;
                
                document.getElementById('edit-total-paid').textContent = `Rs. ${totalPaid.toFixed(2)}`;
                document.getElementById('edit-remaining-amount').textContent = `Rs. ${remaining.toFixed(2)}`;
                document.getElementById('edit-remaining-amount').className = remaining > 0 ? 'amount-negative' : 'amount-positive';
            }
        }

        // Fish item functions
        function addFishItem() {
            const fishType = document.getElementById('fish-type').value;
            const customFishName = document.getElementById('custom-fish-name').value.trim();
            const weight = parseFloat(document.getElementById('item-weight').value);
            const price = parseFloat(document.getElementById('item-price').value);

            if (!fishType || isNaN(weight) || weight <= 0 || isNaN(price) || price <= 0) {
                alert('Please fill all fish item fields with valid data');
                return;
            }

            const fishName = fishType === 'Other' ? customFishName : fishType;
            if (!fishName) {
                alert('Please enter fish name');
                return;
            }

            const total = weight * price;
            const item = { 
                description: fishName, 
                weight: weight + ' kg', 
                price: price, 
                total: total 
            };

            app.currentInvoiceItems.push(item);
            updateInvoiceItemsList();
            updateInvoiceTotal();
            calculateRemaining();
            
            // Clear form
            document.getElementById('fish-type').value = '';
            document.getElementById('custom-fish-name').value = '';
            document.getElementById('item-weight').value = '';
            document.getElementById('item-price').value = '';
            document.getElementById('custom-fish-type').style.display = 'none';
        }

        function addExpenseItem() {
            const description = document.getElementById('expense-description').value.trim();
            const amount = parseFloat(document.getElementById('expense-amount').value);

            if (!description || isNaN(amount) || amount <= 0) {
                alert('Please fill all expense fields with valid data');
                return;
            }

            const expense = { 
                description: description, 
                amount: amount 
            };

            app.currentExpenseItems.push(expense);
            updateExpenseItemsList();
            updateInvoiceTotal();
            calculateRemaining();
            
            // Clear form
            document.getElementById('expense-description').value = '';
            document.getElementById('expense-amount').value = '';
        }

        function updateInvoiceItemsList() {
            const itemsList = document.getElementById('invoice-items-list');
            itemsList.innerHTML = app.currentInvoiceItems.map((item, index) => `
                <div class="fish-item">
                    <div class="item-details">
                        <strong>${app.escapeHtml(item.description)}</strong>
                        <div>${item.weight} @ Rs. ${item.price}/kg = Rs. ${item.total}</div>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-sm btn-danger" onclick="removeInvoiceItem(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function updateExpenseItemsList() {
            const itemsList = document.getElementById('expense-items-list');
            itemsList.innerHTML = app.currentExpenseItems.map((expense, index) => `
                <div class="expense-item">
                    <div class="item-details">
                        <strong>${app.escapeHtml(expense.description)}</strong>
                        <div>Rs. ${expense.amount}</div>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-sm btn-danger" onclick="removeExpenseItem(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function removeInvoiceItem(index) {
            app.currentInvoiceItems.splice(index, 1);
            updateInvoiceItemsList();
            updateInvoiceTotal();
            calculateRemaining();
        }

        function removeExpenseItem(index) {
            app.currentExpenseItems.splice(index, 1);
            updateExpenseItemsList();
            updateInvoiceTotal();
            calculateRemaining();
        }

        function updateInvoiceTotal() {
            const fishTotal = app.currentInvoiceItems.reduce((sum, item) => sum + item.total, 0);
            const expenseTotal = app.currentExpenseItems.reduce((sum, expense) => sum + expense.amount, 0);
            const total = fishTotal + expenseTotal;
            document.getElementById('invoice-total').textContent = `Total: Rs. ${total.toFixed(2)}`;
            togglePaymentFields(); // Update payment fields when total changes
        }

        // UI Functions - 100% Working
        function showAddShopForm() {
            document.getElementById('shops-main').classList.add('hidden');
            document.getElementById('add-shop-form').classList.remove('hidden');
            document.getElementById('shop-name').value = '';
            document.getElementById('shop-owner').value = '';
            document.getElementById('shop-phone').value = '';
            document.getElementById('shop-address').value = '';
            document.querySelector('.logo-preview').innerHTML = '<i class="fas fa-camera"></i> Click to upload logo';
            document.querySelector('.stamp-preview').innerHTML = '<i class="fas fa-stamp"></i> Click to upload stamp';
            window.tempLogo = null;
            window.tempStamp = null;
        }

        function hideAddShopForm() {
            document.getElementById('shops-main').classList.remove('hidden');
            document.getElementById('add-shop-form').classList.add('hidden');
        }

        function hideEditShopForm() {
            app.hideEditShopForm();
        }

        function deleteCurrentShop() {
            if (app.editingShopId) {
                app.deleteShop(app.editingShopId);
                hideEditShopForm();
            }
        }

        function showAddCustomerForm() {
            document.getElementById('customers-main').classList.add('hidden');
            document.getElementById('add-customer-form').classList.remove('hidden');
            document.getElementById('customer-name').value = '';
            document.getElementById('customer-phone').value = '';
            document.getElementById('customer-address').value = '';
        }

        function hideAddCustomerForm() {
            document.getElementById('customers-main').classList.remove('hidden');
            document.getElementById('add-customer-form').classList.add('hidden');
        }

        function showCreateInvoiceForm() {
            document.getElementById('invoices-main').classList.add('hidden');
            document.getElementById('create-invoice-form').classList.remove('hidden');
            app.currentInvoiceItems = [];
            app.currentExpenseItems = [];
            updateInvoiceItemsList();
            updateExpenseItemsList();
            updateInvoiceTotal();
            togglePaymentFields();
        }

        function hideCreateInvoiceForm() {
            document.getElementById('invoices-main').classList.remove('hidden');
            document.getElementById('create-invoice-form').classList.add('hidden');
        }

        function hideEditInvoiceForm() {
            app.hideEditInvoiceForm();
        }

        function saveShop() {
            const name = document.getElementById('shop-name').value.trim();
            const owner = document.getElementById('shop-owner').value.trim();
            const phone = document.getElementById('shop-phone').value.trim();
            const address = document.getElementById('shop-address').value.trim();

            if (!name || !owner || !phone) {
                alert('Please fill all required fields');
                return;
            }

            const shopData = {
                name,
                owner,
                phone,
                address,
                logo: window.tempLogo || null,
                stamp: window.tempStamp || null
            };

            app.addShop(shopData);
            hideAddShopForm();
        }

        function saveCustomer() {
            const shopId = document.getElementById('customer-shop').value;
            const name = document.getElementById('customer-name').value.trim();
            const phone = document.getElementById('customer-phone').value.trim();
            const address = document.getElementById('customer-address').value.trim();

            if (!shopId || !name || !phone) {
                alert('Please fill all required fields');
                return;
            }

            app.addCustomer({ shopId, name, phone, address });
            hideAddCustomerForm();
        }

        // FIXED: saveInvoice function with proper validation
        function saveInvoice() {
            const shopId = document.getElementById('invoice-shop').value;
            const customerId = document.getElementById('invoice-customer').value;
            const status = document.getElementById('invoice-status').value;
            let amountPaid = parseFloat(document.getElementById('amount-paid').value) || 0;

            if (!shopId || !customerId) {
                alert('Please select both shop and customer');
                return;
            }

            if (app.currentInvoiceItems.length === 0) {
                alert('Please add at least one fish item to the invoice');
                return;
            }

            // Calculate total amount
            const fishTotal = app.currentInvoiceItems.reduce((sum, item) => sum + item.total, 0);
            const expenseTotal = app.currentExpenseItems.reduce((sum, expense) => sum + expense.amount, 0);
            const totalAmount = fishTotal + expenseTotal;

            // Validate payment status and amounts
            if (status === 'paid') {
                amountPaid = totalAmount; // Force full payment for paid status
            } else if (status === 'pending') {
                amountPaid = 0; // Force zero payment for pending status
            } else if (status === 'partial') {
                if (amountPaid <= 0) {
                    alert('Please enter amount paid for partial payment');
                    return;
                }
                if (amountPaid >= totalAmount) {
                    alert('For partial payment, amount paid must be less than total amount');
                    return;
                }
            }

            const customer = app.customers.find(c => c.id == customerId);

            const invoiceData = {
                shopId: parseInt(shopId),
                customerId: parseInt(customerId),
                customerName: customer.name,
                status: status,
                amountPaid: amountPaid,
                items: [...app.currentInvoiceItems],
                expenses: [...app.currentExpenseItems]
            };

            app.addInvoice(invoiceData);
            hideCreateInvoiceForm();
        }

        function updateInvoice() {
            app.updateInvoice();
        }

        function searchCustomers() {
            const searchTerm = document.getElementById('customer-search').value.toLowerCase();
            const customerCards = document.querySelectorAll('#customers-list .card');
            
            customerCards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }

        function searchInvoices() {
            const searchTerm = document.getElementById('invoice-search').value.toLowerCase();
            const invoiceCards = document.querySelectorAll('#invoices-list .card');
            
            invoiceCards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }

        // Mobile-specific enhancements
        function initMobileFeatures() {
            // Prevent double-tap zoom
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function (event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);

            // Better touch feedback
            const buttons = document.querySelectorAll('.btn, .nav-tab, .action-buttons .btn');
            buttons.forEach(button => {
                button.addEventListener('touchstart', function() {
                    this.style.opacity = '0.7';
                });
                button.addEventListener('touchend', function() {
                    this.style.opacity = '1';
                });
            });

            // Handle orientation changes
            window.addEventListener('orientationchange', function() {
                setTimeout(() => {
                    window.scrollTo(0, 0);
                }, 100);
            });
        }

        // Initialize the app
        const app = new QaziFishTradersApp();

        // Initialize mobile features
        document.addEventListener('DOMContentLoaded', function() {
            initMobileFeatures();
        });

        // Make functions globally available
        window.showAddShopForm = showAddShopForm;
        window.hideAddShopForm = hideAddShopForm;
        window.showAddCustomerForm = showAddCustomerForm;
        window.hideAddCustomerForm = hideAddCustomerForm;
        window.showCreateInvoiceForm = showCreateInvoiceForm;
        window.hideCreateInvoiceForm = hideCreateInvoiceForm;
        window.hideEditShopForm = hideEditShopForm;
        window.hideEditInvoiceForm = hideEditInvoiceForm;
        window.deleteCurrentShop = deleteCurrentShop;
        window.saveShop = saveShop;
        window.saveCustomer = saveCustomer;
        window.addFishItem = addFishItem;
        window.addExpenseItem = addExpenseItem;
        window.removeInvoiceItem = removeInvoiceItem;
        window.removeExpenseItem = removeExpenseItem;
        window.saveInvoice = saveInvoice;
        window.updateInvoice = updateInvoice;
        window.searchCustomers = searchCustomers;
        window.searchInvoices = searchInvoices;
        window.togglePaymentFields = togglePaymentFields;
        window.toggleEditPaymentFields = toggleEditPaymentFields;
        window.calculateRemaining = calculateRemaining;
        window.calculateEditRemaining = calculateEditRemaining;
        window.previewLogo = previewLogo;
        window.previewStamp = previewStamp;
        window.previewEditLogo = previewEditLogo;
        window.previewEditStamp = previewEditStamp;
        window.app = app;

        console.log("Complete Fish Business App initialized successfully!");
    </script>
</body>
</html>
[file content end]
